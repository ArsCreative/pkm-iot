<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Terra Monitoring</title>

  <script src="https://unpkg.com/lucide@latest"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#070a13;
      --bg1:#0b1226;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.10);
      --text:#e5e7eb;
      --muted:#a3a3a3;

      --primary:#60a5fa;
      --accent:#22d3ee;

      --success:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;

      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(900px 600px at 10% 5%, rgba(34,211,238,.20), transparent 60%),
        radial-gradient(900px 600px at 90% 15%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(900px 600px at 50% 95%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding: 22px;
      display:flex;
      justify-content:center;
    }

    .wrap{
      width:100%;
      max-width: 1040px;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 16px;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }

    .logo{
      width:44px;
      height:44px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg, rgba(96,165,250,.35), rgba(34,211,238,.25));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .sub{
      margin:3px 0 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      user-select:none;
    }

    .dot{
      width:10px; height:10px;
      border-radius: 999px;
      background: var(--warn);
      box-shadow: 0 0 0 6px rgba(245,158,11,.15);
    }
    .dot.on{
      background: var(--success);
      box-shadow: 0 0 0 6px rgba(34,197,94,.18);
    }
    .dot.offline{
      background: var(--danger);
      box-shadow: 0 0 0 6px rgba(239,68,68,.18);
    }
    .statusText{
      font-weight: 700;
      font-size: 13px;
    }
    .statusMeta{
      font-size: 12px;
      color: var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-top: 14px;
    }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 120px at 30% 0%, rgba(96,165,250,.25), transparent 55%);
      pointer-events:none;
      opacity:.8;
    }

    .cardInner{
      position:relative;
      padding: 18px 18px 16px;
    }

    .title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .2px;
      font-size: 13px;
      text-transform: uppercase;
    }

    .titleLeft{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .ico{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
    }

    .val{
      font-size: 44px;
      font-weight: 900;
      letter-spacing: .3px;
      margin: 6px 0 2px;
      line-height: 1.05;
    }

    .meta{
      color: var(--muted);
      font-size: 13px;
      margin-top: 8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--text);
    }

    .bar{
      height: 5px;
      width: 100%;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      margin-top: 14px;
    }

    .bar > span{
      display:block;
      height:100%;
      width: 45%;
      background: linear-gradient(90deg, rgba(34,211,238,.9), rgba(96,165,250,.9));
      border-radius: 999px;
      box-shadow: 0 0 18px rgba(34,211,238,.25);
      transition: width .35s ease;
    }

    /* WATER state */
    .stateBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.2px;
      text-transform: uppercase;
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }

    .stateBadge.on{
      color: #fff;
      background: rgba(239,68,68,.18);
      border-color: rgba(239,68,68,.35);
      box-shadow: 0 0 0 6px rgba(239,68,68,.10);
    }
    .stateBadge.off{
      color: #0b1b10;
      background: rgba(34,197,94,.20);
      border-color: rgba(34,197,94,.35);
      box-shadow: 0 0 0 6px rgba(34,197,94,.10);
    }

    .valWater.on{ color: var(--danger); text-shadow: 0 0 14px rgba(239,68,68,.20); }
    .valWater.off{ color: var(--success); text-shadow: 0 0 14px rgba(34,197,94,.18); }

    .barWater.on > span{
      background: linear-gradient(90deg, rgba(239,68,68,.95), rgba(245,158,11,.85));
      box-shadow: 0 0 18px rgba(239,68,68,.25);
      width: 100%;
    }
    .barWater.off > span{
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(16,185,129,.85));
      box-shadow: 0 0 18px rgba(34,197,94,.22);
      width: 25%;
    }

    /* CONTROL PANEL STYLES (NEW) */
    .controlPanel {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px dashed var(--border);
    }
    .controlLabel {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .controlFlex {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .controlInput {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: #fff;
      padding: 8px 12px;
      width: 75px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .controlInput:focus { border-color: var(--primary); }
    .controlBtn {
      background: linear-gradient(135deg, rgba(96,165,250,.9), rgba(34,211,238,.9));
      border: none;
      border-radius: 8px;
      color: #070a13;
      font-weight: bold;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 13px;
      transition: opacity 0.2s;
    }
    .controlBtn:hover { opacity: 0.8; }
    .controlStatus {
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
    }

    /* Layout */
    .span6{ grid-column: span 6; }
    .span12{ grid-column: span 12; }

    @media (max-width: 900px){
      .span6{ grid-column: span 12; }
    }

    /* Chart card */
    .chartWrap{
      height: 260px;
      margin-top: 8px;
    }

    footer{
      margin-top: 18px;
      color: var(--muted);
      font-size: 13px;
      text-align:center;
      padding: 18px 0 6px;
      opacity: .9;
    }

    a{ color: inherit; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo" title="IoT">
          <i data-lucide="leaf"></i>
        </div>
        <div>
          <h1>Monitoring Kelembaban Tanah</h1>
          <div class="sub">Terra Monitoring • Realtime</div>
        </div>
      </div>

      <div class="statusPill" title="Status MQTT">
        <span id="dot" class="dot"></span>
        <div>
          <div id="statusText" class="statusText">Connecting…</div>
          <div id="statusMeta" class="statusMeta">Menyiapkan koneksi</div>
        </div>
      </div>
    </div>

    <div class="grid">

      <div class="card span6">
        <div class="cardInner">
          <div class="title">
            <div class="titleLeft">
              <div class="ico"><i data-lucide="droplets"></i></div>
              Kelembaban Tanah
            </div>
            <span class="stateBadge" id="humBadge">LIVE</span>
          </div>

          <div class="val" id="hum">--</div>

          <div class="meta">
            <span class="chip"><i data-lucide="thermometer"></i> <span id="temp">--</span></span>
            <span class="chip"><i data-lucide="clock"></i> <span id="humTime">Menunggu data…</span></span>
            <span class="chip"><i data-lucide="wifi"></i> <span id="humTopic">wemos1/iot/humidity</span></span>
          </div>

          <div class="bar" aria-label="humidity bar">
            <span id="humBar" style="width:0%"></span>
          </div>
        </div>
      </div>

      <div class="card span6">
        <div class="cardInner">
          <div class="title">
            <div class="titleLeft">
              <div class="ico"><i data-lucide="waves"></i></div>
              Status Pompa Air
            </div>
            <span class="stateBadge" id="waterBadge">UNKNOWN</span>
          </div>

          <div class="val valWater" id="water">--</div>

          <div class="meta">
            <span class="chip"><i data-lucide="cpu"></i> <span id="waterDevice">Unknown</span></span>
            <span class="chip"><i data-lucide="clock"></i> <span id="waterTime">Menunggu data…</span></span>
            <span class="chip"><i data-lucide="wifi"></i> <span id="waterTopic">wemos1/iot/water</span></span>
          </div>

          <div class="bar barWater" id="waterBar" aria-label="water bar">
            <span></span>
          </div>

          <div class="controlPanel">
            <div class="controlLabel">Batas Kelembaban Pompa Menyala (%)</div>
            <div class="controlFlex">
              <input type="number" id="thresholdInput" class="controlInput" min="1" max="100" placeholder="--">
              <button id="btnSetThreshold" class="controlBtn">Ubah Batas</button>
            </div>
            <div class="controlStatus" id="thresholdStatus">Sinkronisasi data...</div>
          </div>
          </div>
      </div>

      <div class="card span12">
        <div class="cardInner">
          <div class="title">
            <div class="titleLeft">
              <div class="ico"><i data-lucide="line-chart"></i></div>
              Grafik Kelembaban Tanah
            </div>
            <span class="stateBadge" id="chartBadge">Realtime</span>
          </div>
          <div class="chartWrap">
            <canvas id="humChart"></canvas>
          </div>
          <div class="meta">
            <span class="chip"><i data-lucide="activity"></i> Auto update setiap 3 detik</span>
          </div>
        </div>
      </div>

    </div>

    <footer>
      Powered by ArsCreative · 2026
    </footer>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    // Icons
    lucide.createIcons();

    // HiveMQ config (punyamu)
    const HOST = "wss://5d06ddf4798c4491a76b7055abe6e283.s1.eu.hivemq.cloud:8884/mqtt";
    const USER = "wemos1";
    const PASS = "We123123";

    const TOPIC_HUM = "wemos1/iot/humidity";
    const TOPIC_WATER = "wemos1/iot/water";
    const TOPIC_CONTROL = "wemos1/iot/control"; // TOPIC BARU UNTUK KONTROL

    // UI refs
    const dot = document.getElementById("dot");
    const statusText = document.getElementById("statusText");
    const statusMeta = document.getElementById("statusMeta");

    const humEl = document.getElementById("hum");
    const tempEl = document.getElementById("temp");
    const humTimeEl = document.getElementById("humTime");
    const humBar = document.getElementById("humBar");

    const waterEl = document.getElementById("water");
    const waterBadge = document.getElementById("waterBadge");
    const waterDevice = document.getElementById("waterDevice");
    const waterTime = document.getElementById("waterTime");
    const waterBar = document.getElementById("waterBar");

    // Refs Control Panel
    const thresholdInput = document.getElementById("thresholdInput");
    const btnSetThreshold = document.getElementById("btnSetThreshold");
    const thresholdStatus = document.getElementById("thresholdStatus");

    // Helpers
    const fmtTime = () => new Date().toLocaleTimeString('id-ID', { hour12:false });
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    function parsePayload(rawText){
      // toleransi payload JSON tidak standar: water:ON (tanpa kutip)
      const fixed = rawText.replace(/:\s?(ON|OFF)([,\s}])/gi, ':"$1"$2');
      try { return JSON.parse(fixed); } catch { return null; }
    }

    function normalizeOnOff(v){
      // dukung ON/OFF, 1/0, true/false, "1"/"0"
      const s = String(v ?? "").trim().toUpperCase();
      if (s === "ON" || s === "TRUE" || s === "1") return "ON";
      if (s === "OFF" || s === "FALSE" || s === "0") return "OFF";
      return null;
    }

    function setConnectionState(state){
      // state: "connecting" | "online" | "offline"
      dot.classList.remove("on", "offline");
      if (state === "online"){
        dot.classList.add("on");
        statusText.textContent = "Sistem Online";
        statusMeta.textContent = "MQTT terhubung";
      } else if (state === "offline"){
        dot.classList.add("offline");
        statusText.textContent = "Offline";
        statusMeta.textContent = "Koneksi terputus";
      } else {
        statusText.textContent = "Connecting…";
        statusMeta.textContent = "Mencoba menghubungkan";
      }
    }

    // Chart setup
    const MAX_POINTS = 60;
    const chartCtx = document.getElementById("humChart");

    const labels = [];
    const humSeries = [];

    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Humidity (%)',
          data: humSeries,
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 2,
          borderColor: '#22d3ee',
          backgroundColor: 'rgba(34,211,238,0.1)',
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          legend: { display: true, labels: { color: '#a3a3a3' } }
        },
        scales: {
          x: { ticks: { color: '#a3a3a3' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y: {
            suggestedMin: 0,
            suggestedMax: 100,
            ticks: { callback: (v) => v + '%', color: '#a3a3a3' },
            grid: { color: 'rgba(255,255,255,0.05)' }
          }
        }
      }
    });

    function pushChartPoint(h){
      const t = fmtTime();
      labels.push(t);
      humSeries.push(h);

      if (labels.length > MAX_POINTS){
        labels.shift();
        humSeries.shift();
      }
      chart.update();
    }

    function updateHumidityUI(h, t){
      const time = fmtTime();

      if (typeof h === "number" && !Number.isNaN(h)){
        humEl.textContent = h.toFixed(0) + "%"; // Dibuat tanpa desimal biar bersih
        const w = clamp(h, 0, 100);
        humBar.style.width = w + "%";
        pushChartPoint(h);
      } else {
        humEl.textContent = "--";
        humBar.style.width = "0%";
      }

      if (typeof t === "number" && !Number.isNaN(t)){
        tempEl.textContent = t.toFixed(1) + "°C";
      } else {
        tempEl.textContent = "--";
      }

      humTimeEl.textContent = "Update: " + time;
    }

    function updateWaterUI(value, device){
      const time = fmtTime();
      const state = normalizeOnOff(value);

      waterDevice.textContent = device || "Unknown";
      waterTime.textContent = "Update: " + time;

      waterEl.classList.remove("on", "off");
      waterBadge.classList.remove("on", "off");
      waterBar.classList.remove("on", "off");

      if (state === "ON"){
        waterEl.textContent = "ON";
        waterEl.classList.add("on");
        waterBadge.textContent = "POMPA ON";
        waterBadge.classList.add("on");
        waterBar.classList.add("on");
      } else if (state === "OFF"){
        waterEl.textContent = "OFF";
        waterEl.classList.add("off");
        waterBadge.textContent = "POMPA OFF";
        waterBadge.classList.add("off");
        waterBar.classList.add("off");
      } else {
        waterEl.textContent = value ?? "--";
        waterBadge.textContent = "UNKNOWN";
      }
    }

    // Connect MQTT
    setConnectionState("connecting");

    const client = mqtt.connect(HOST, {
      username: USER,
      password: PASS,
      clientId: "web_client_" + Math.random().toString(16).slice(2),
      clean: true,
      connectTimeout: 10000,
      reconnectPeriod: 2000
    });

    client.on("connect", () => {
      setConnectionState("online");
      client.subscribe([TOPIC_HUM, TOPIC_WATER], { qos: 0 });
    });

    client.on("reconnect", () => {
      setConnectionState("connecting");
    });

    client.on("close", () => {
      setConnectionState("offline");
    });

    client.on("offline", () => {
      setConnectionState("offline");
    });

    client.on("error", () => {
      setConnectionState("offline");
    });

    client.on("message", (topic, message) => {
      const raw = message.toString();
      const obj = parsePayload(raw);

      if (!obj) return;

      if (topic === TOPIC_HUM) {
        const h = (obj.humidity != null) ? Number(obj.humidity) : NaN;
        const t = (obj.temp != null) ? Number(obj.temp) : NaN;
        const thresh = (obj.threshold != null) ? Number(obj.threshold) : null;
        
        updateHumidityUI(h, t);

        // Update value di form otomatis HANYA JIKA user tidak sedang mengetik di dalam input box nya
        if (thresh !== null && document.activeElement !== thresholdInput) {
          thresholdInput.value = thresh;
          thresholdStatus.textContent = "Nilai di perangkat saat ini: " + thresh + "%";
          thresholdStatus.style.color = "var(--muted)";
        }
      }

      if (topic === TOPIC_WATER) {
        const w = (obj.water != null) ? obj.water : obj.state;
        updateWaterUI(w, obj.device);
      }
    });

    // EVENT LISTENER TOMBOL SET THRESHOLD
    btnSetThreshold.addEventListener("click", () => {
      const val = parseInt(thresholdInput.value);
      if (isNaN(val) || val < 1 || val > 100) {
        alert("Harap masukkan angka persentase antara 1 sampai 100!");
        return;
      }

      const payload = JSON.stringify({ threshold: val });
      
      thresholdStatus.textContent = "Mengirim perintah ke perangkat...";
      thresholdStatus.style.color = "var(--warn)";

      // Publish perintah ke ESP8266
      client.publish(TOPIC_CONTROL, payload, { qos: 1 }, (err) => {
        if (!err) {
          // Sukses kirim
          thresholdStatus.textContent = "Perintah terkirim! Menunggu konfirmasi...";
        } else {
          // Gagal kirim
          thresholdStatus.textContent = "Gagal mengirim jaringan sibuk.";
          thresholdStatus.style.color = "var(--danger)";
        }
      });
    });

  </script>
</body>
</html>
