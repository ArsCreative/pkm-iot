<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TerraMon Setup</title>
<style>
  :root{
    /* --- DARK MODE PALETTE --- */
    /* Mengubah background jadi biru malam/ungu gelap */
    --bg1:#0f172a; --bg2:#1e1b4b; 
    /* Card tetap transparan cerah agar kontras dengan BG gelap */
    --card:rgba(255,255,255,.08);
    --card2:rgba(255,255,255,.12); 
    --txt:#f1f5f9; --muted:rgba(241,245,249,.70);
    --ok:#4ade80; --bad:#f87171;
    --border-color: rgba(255,255,255,.15); /* Warna border konsisten */
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color:var(--txt);
    /* Background digelapkan, intensitas cahaya putih (radial) dikurangi biar lebih dramatis */
    background: radial-gradient(1200px 700px at 20% 20%, rgba(255,255,255,.07), transparent 60%),
                radial-gradient(900px 600px at 80% 80%, rgba(255,255,255,.05), transparent 55%),
                linear-gradient(160deg, var(--bg1), var(--bg2));
  }
  .wrap{width:min(920px, 92vw); padding:28px}
  .card{
    background: linear-gradient(180deg, var(--card), var(--card2));
    border:1px solid var(--border-color);
    border-radius:24px; /* Sedikit lebih bulat */
    /* Shadow lebih dalam untuk efek melayang di kegelapan */
    box-shadow: 0 25px 50px -12px rgba(0,0,0,.5);
    backdrop-filter: blur(10px); /* Tambahan efek kaca buram */
    -webkit-backdrop-filter: blur(10px);
    overflow:hidden;
  }
  header{
    padding:24px 24px 16px;
    display:flex; gap:14px; align-items:center; justify-content:space-between;
    border-bottom:1px solid var(--border-color);
  }
  .brand{display:flex; flex-direction:column; gap:6px}
  .brand h1{font-size:20px; margin:0; letter-spacing:.5px; font-weight: 700;}
  .brand p{margin:0; font-size:13px; color:var(--muted)}
  .pill{
    padding:8px 14px; border-radius:999px; font-size:12px; font-weight: 600;
    border:1px solid var(--border-color);
    background:rgba(0,0,0,.25); /* Lebih gelap */
    letter-spacing: 0.5px;
  }
  .grid{display:grid; grid-template-columns: 1.15fr .85fr; gap:20px; padding:20px}
  @media (max-width: 860px){ .grid{grid-template-columns:1fr} }
  .panel{
    padding:18px; border-radius:20px;
    border:1px solid var(--border-color);
    background:rgba(0,0,0,.2); /* Panel lebih gelap */
  }
  .panel h2{margin:0 0 12px; font-size:15px; letter-spacing:.3px; text-transform: uppercase; color: var(--muted); font-weight: 600;}
  .row{display:flex; gap:10px; align-items:center; justify-content:space-between; margin:10px 0}
  .btn{
    appearance:none; border:0; cursor:pointer;
    padding:12px 16px; border-radius:14px; font-weight:700; font-size: 14px;
    /* Gradient tombol lebih tajam (neon look) */
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    color:white;
    /* Glow effect pada tombol */
    box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.5);
    transition: all .15s ease;
    letter-spacing: 0.5px;
  }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 15px 25px -5px rgba(59, 130, 246, 0.6); }
  .btn:active{transform: translateY(1px); box-shadow: 0 5px 10px -5px rgba(59, 130, 246, 0.4);}
  
  .btn.secondary{
    background:rgba(255,255,255,.08); color:var(--txt);
    border:1px solid var(--border-color); box-shadow:none;
    font-weight: 600;
  }
  .btn.secondary:hover{ background:rgba(255,255,255,.12); border-color: rgba(255,255,255,.3); }

  .list{display:grid; gap:10px; margin-top:14px}
  .net{
    padding:14px; border-radius:16px;
    border:1px solid var(--border-color);
    background:rgba(255,255,255,.05);
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    transition: all 0.2s ease;
  }
  .net:hover{
    background:rgba(255,255,255,.1);
    border-color: rgba(255,255,255,.4);
    transform: translateX(5px);
  }
  .ssid{font-weight:700; font-size: 15px;}
  .meta{font-size:12px; color:var(--muted); margin-top:4px}
  .bars{display:flex; gap:3px; align-items:flex-end; height:16px; min-width:46px; justify-content:flex-end}
  .bar{width:6px; border-radius:4px; background:rgba(255,255,255,.3)}
  .bar.on{background: #38bdf8; box-shadow: 0 0 8px rgba(56, 189, 248, 0.6);} /* Bar sinyal menyala biru */
  label{font-size:12px; color:var(--muted); font-weight: 600; margin-left: 4px;}
  input{
    width:100%; padding:14px 16px; border-radius:16px;
    border:1px solid var(--border-color);
    background:rgba(0,0,0,.3); color:var(--txt); /* Input lebih gelap */
    outline:none; font-size: 15px;
    transition: all 0.2s ease;
  }
  input:focus{
    border-color: #3b82f6;
    background:rgba(0,0,0,.4);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
  }
  input::placeholder{color:rgba(255,255,255,.4)}
  .hint{font-size:12px; color:var(--muted); margin-top:12px; line-height:1.5; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;}
  .status{font-size:13px; margin-top:12px; font-weight: 600; text-align: center;}
  .ok{color:var(--ok)}
  .bad{color:var(--bad)}
  footer{padding:16px 24px; border-top:1px solid var(--border-color); color:var(--muted); font-size:12px; text-align: center;}
  b{color: white;}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="brand">
          <h1>TerraMon Setup</h1>
          <p>Portal konfigurasi Wi-Fi untuk perangkat monitoring.</p>
        </div>
        <div class="pill" id="chip">TerraMon Device</div>
      </header>

      <div class="grid">
        <div class="panel">
          <div class="row" style="margin-top:0">
            <h2 style="margin:0">Jaringan Tersedia</h2>
            <button class="btn secondary" onclick="scan()">Scan Ulang</button>
          </div>
          <div class="list" id="nets">
            <div class="net" style="opacity: 0.7;">
              <div>
                <div class="ssid">Menunggu Scan...</div>
                <div class="meta">Klik 'Scan Ulang' jika belum muncul</div>
              </div>
              <div class="bars">
                <div class="bar on" style="height:6px"></div>
                <div class="bar" style="height:10px"></div>
                <div class="bar" style="height:14px"></div>
                <div class="bar" style="height:16px"></div>
              </div>
            </div>
          </div>
          <div class="hint">
            üí° <b>Tips:</b> Jika portal tidak terbuka otomatis setelah terhubung ke Hotspot, buka browser dan ketik <b>http://192.168.4.1</b>
          </div>
        </div>

        <div class="panel">
          <h2>Koneksi</h2>
          <div style="margin-bottom: 8px;"><label>Nama Jaringan (SSID)</label></div>
          <input id="ssid" placeholder="Pilih dari daftar di kiri..." readonly style="cursor: pointer; opacity: 0.8;" onclick="alert('Silakan klik salah satu jaringan di daftar sebelah kiri.');"/>
          
          <div style="height:16px"></div>
          
          <div style="margin-bottom: 8px;"><label>Password</label></div>
          <input id="pass" type="password" placeholder="Masukkan password Wi-Fi..." />
          
          <div class="row" style="margin-top:20px">
            <button class="btn" onclick="save()">Simpan &amp; Hubungkan</button>
          </div>
          <div style="margin-top: 10px;">
             <button class="btn secondary" style="width:100%" onclick="factory()">Reset Pengaturan Wi-Fi</button>
          </div>
         
          <div class="status" id="status"></div>
        </div>
      </div>

      <footer>
        TerraMon IoT Project ‚Ä¢ ArsCreative @2026.
      </footer>
    </div>
  </div>

<script>
// Fungsi bar sinyal dengan warna biru menyala
function barsFor(rssi){
  let lvl = 0;
  if (rssi > -55) lvl = 4;
  else if (rssi > -65) lvl = 3;
  else if (rssi > -75) lvl = 2;
  else if (rssi > -85) lvl = 1;
  else lvl = 0;
  let b = '';
  for(let i=1;i<=4;i++){
    // Tambah class 'on' untuk efek menyala
    b += `<div class="bar ${i<=lvl?'on':''}" style="height:${6+i*3}px"></div>`;
  }
  return b;
}

async function scan(){
  const el = document.getElementById('nets');
  el.innerHTML = `<div class="net" style="animation: pulse 1.5s infinite;"><div><div class="ssid">Scanning...</div><div class="meta">Sedang mencari jaringan di sekitar</div></div><div class="bars">${barsFor(-70)}</div></div>`;
  
  // Tambah CSS animasi pulse untuk efek scanning
  if(!document.getElementById('scanAnim')){
      let s = document.createElement('style');
      s.id = 'scanAnim';
      s.innerHTML = `@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }`;
      document.head.appendChild(s);
  }

  try{
    const r = await fetch('/scan');
    const j = await r.json();
    if(!j || !j.networks){ throw new Error('bad'); }
    if(j.networks.length === 0){
      el.innerHTML = `<div class="net"><div style="color:var(--bad)"><div class="ssid">Tidak ada jaringan</div><div class="meta">Coba pindah posisi dan scan ulang</div></div><div class="bars">${barsFor(-95)}</div></div>`;
      return;
    }
    el.innerHTML = '';
    // Sortir berdasarkan sinyal terkuat
    j.networks.sort((a, b) => b.rssi - a.rssi);
    
    j.networks.forEach(n=>{
      // Kunci gembok lebih keren
      const lock = n.sec ? 'üîí' : '';
      const item = document.createElement('div');
      item.className = 'net';
      // Tambah cursor pointer biar jelas bisa diklik
      item.style.cursor = 'pointer';
      item.innerHTML = `
        <div>
          <div class="ssid">${escapeHtml(n.ssid || '(Hidden Network)')} <span style="font-size:12px; margin-left:5px">${lock}</span></div>
          <div class="meta">Signal: ${n.rssi} dBm</div>
        </div>
        <div class="bars">${barsFor(n.rssi)}</div>
      `;
      item.onclick = ()=>{
        const ssidInput = document.getElementById('ssid');
        ssidInput.value = n.ssid || '';
        ssidInput.style.opacity = '1'; // Balikin opacity normal setelah dipilih
        document.getElementById('pass').focus();
        // Efek visual saat dipilih
        document.querySelectorAll('.net').forEach(net => net.style.borderColor = 'var(--border-color)');
        item.style.borderColor = '#3b82f6';
      };
      el.appendChild(item);
    });
  }catch(e){
    el.innerHTML = `<div class="net"><div style="color:var(--bad)"><div class="ssid">Gagal Scan API</div><div class="meta">Pastikan device backend berjalan normal.</div></div><div class="bars">${barsFor(-95)}</div></div>`;
  }
}

async function save(){
  const ssid = document.getElementById('ssid').value.trim();
  const pass = document.getElementById('pass').value;
  const st = document.getElementById('status');
  
  if(!ssid){
    st.innerHTML = `<span class="bad">‚ö†Ô∏è Harap pilih jaringan (SSID) terlebih dahulu dari daftar di kiri.</span>`;
    // Goyangkan input box
    const panel = document.querySelectorAll('.panel')[1];
    panel.style.animation = "shake 0.3s";
    setTimeout(() => panel.style.animation = "", 300);
    
    if(!document.getElementById('shakeAnim')){
        let s = document.createElement('style'); s.id = 'shakeAnim';
        s.innerHTML = `@keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }`;
        document.head.appendChild(s);
    }
    return;
  }
  
  st.innerHTML = `<span style="color:#38bdf8">‚è≥ Sedang menyimpan konfigurasi dan mencoba terhubung...</span>`;
  const body = new URLSearchParams({ssid, pass});
  try{
    const r = await fetch('/save', {method:'POST', body});
    if(r.ok){
       st.innerHTML = `<span class="ok">‚úÖ Berhasil disimpan! Device akan restart dan terhubung ke <b>${escapeHtml(ssid)}</b>. Silakan tutup halaman ini.</span>`;
       // Disable tombol setelah sukses
       document.querySelectorAll('.btn').forEach(b => b.disabled = true);
    } else {
       throw new Error('Gagal');
    }
  }catch(e){
    st.innerHTML = `<span class="bad">‚ùå Gagal menyimpan. Coba lagi.</span>`;
  }
}

async function factory(){
  if(!confirm("Yakin ingin mereset pengaturan Wi-Fi? Device akan restart dan kembali ke mode Hotspot (AP).")) return;
  
  const st = document.getElementById('status');
  st.innerHTML = `‚è≥ Mereset pengaturan...`;
  try{
    const r = await fetch('/reset', {method:'POST'});
    if(r.ok){
       st.innerHTML = `<span class="ok">‚úÖ Wi-Fi berhasil direset. Device restart...</span>`;
    } else { throw new Error('Gagal'); }
  }catch(e){
    st.innerHTML = `<span class="bad">‚ùå Gagal reset.</span>`;
  }
}

function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

(async ()=>{
  // Ubah teks chip di pojok kanan atas sesuai request
  document.getElementById('chip').textContent = 'TerraMon ‚Ä¢ Wemos D1 Mini';
  // Hapus auto-scan di awal biar user klik manual dan lebih interaktif
  // await scan(); 
})();
</script>
</body>
</html>